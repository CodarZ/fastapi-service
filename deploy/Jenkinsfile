pipeline {
    agent any

    environment {
        GIT_REPO = "git@github.com:CodarZ/fastapi-service.git"
        IMAGE_NAME = "fs-image"
        DOCKERFILE_PATH = "deploy/Dockerfile"
    }

    stages {
        stage('å‡†å¤‡çŽ¯å¢ƒ') {
            steps {
                script {
                    echo "â–¶ï¸ å¼€å§‹æž„å»º FastAPI æœåŠ¡..."
                    sh 'whoami'
                    sh 'python3 --version || true'
                    sh 'docker --version || true'
                }
            }
        }

        stage('è®¡ç®—çŽ¯å¢ƒå˜é‡') {
            steps {
                script {
                    determineEnvironment()
                    echo "ðŸ“Œ éƒ¨ç½²çŽ¯å¢ƒ: ${env.ENVIRONMENT} | ç«¯å£: ${env.DOCKER_PORT} | å®¹å™¨å: ${env.CONTAINER_NAME}"
                }
            }
        }

        stage('æ‹‰å–ä»£ç ') {
            steps {
                echo "ðŸ”„ ä»Ž Git ä»“åº“æ‹‰å– ${env.BRANCH_NAME} åˆ†æ”¯çš„æœ€æ–°ä»£ç ..."
                git branch: "${env.BRANCH_NAME}", url: "${env.GIT_REPO}"
            }
        }

        stage('æž„å»º Docker é•œåƒ') {
            steps {
                script {
                    def timestamp = sh(script: 'date +%Y%m%d%H%M%S', returnStdout: true).trim()
                    env.IMAGE_TAG = "${env.IMAGE_NAME}:${timestamp}"

                    echo "ðŸ”¨ æž„å»º Docker é•œåƒ: ${env.IMAGE_TAG}"
                    sh """
                    docker build --cache-from=${env.IMAGE_NAME}:latest -t ${env.IMAGE_TAG} -f ${env.DOCKERFILE_PATH} .
                    docker tag ${env.IMAGE_TAG} ${env.IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage('åœæ­¢æ—§å®¹å™¨') {
            steps {
                script {
                    if (containerExists(env.CONTAINER_NAME)) {
                        echo "ðŸ›‘ åœæ­¢æ—§å®¹å™¨: ${env.CONTAINER_NAME}"
                        sh "docker stop ${env.CONTAINER_NAME} --time 10 || true"
                        sh "docker rm ${env.CONTAINER_NAME} || true"
                    } else {
                        echo "âœ… æ—§å®¹å™¨ä¸å­˜åœ¨ï¼Œæ— éœ€åœæ­¢ã€‚"
                    }
                }
            }
        }

        stage('éƒ¨ç½²æ–°å®¹å™¨') {
            steps {
                script {
                    echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨: ${env.CONTAINER_NAME} (ç«¯å£: ${env.DOCKER_PORT})"
                    sh """
                    docker run -d \
                        --name ${env.CONTAINER_NAME} \
                        -p ${env.DOCKER_PORT}:8000 \
                        -e ENVIRONMENT=${env.ENVIRONMENT} \
                        ${env.IMAGE_TAG}
                    """
                }
            }
        }

        stage('éªŒè¯éƒ¨ç½²') {
            steps {
                script {
                    if (!containerExists(env.CONTAINER_NAME)) {
                        error "âŒ å®¹å™¨ ${env.CONTAINER_NAME} æœªè¿è¡Œï¼"
                    }

                    def healthCheck = sh(
                        script: "curl -s -o /dev/null -w '%{http_code}' http://localhost:${env.DOCKER_PORT}/health || echo '000'",
                        returnStdout: true
                    ).trim()

                    echo "ðŸ” å¥åº·æ£€æŸ¥ HTTP çŠ¶æ€ç : ${healthCheck}"

                    if (healthCheck != "200") {
                        echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP ${healthCheck})ï¼Œä½†ä¸ä¼šå½±å“æµæ°´çº¿ç»§ç»­è¿è¡Œã€‚"
                    } else {
                        echo "âœ… æœåŠ¡åœ¨ç«¯å£ ${env.DOCKER_PORT} ä¸Šæ­£å¸¸è¿è¡Œ"
                    }
                }
            }
        }

        stage('æ£€æŸ¥æ—¥å¿—') {
            steps {
                echo "ðŸ“œ æ‰“å°æœ€è¿‘ 50 è¡Œå®¹å™¨æ—¥å¿—: ${env.CONTAINER_NAME}"
                sh "docker logs --tail 50 ${env.CONTAINER_NAME} || true"
            }
        }
    }

    post {
        success {
            echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
        }
        failure {
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼"
        }
        always {
            script {
                echo "ðŸ§¹ æ¸…ç† 24 å°æ—¶å‰çš„æ— ç”¨ Docker èµ„æº..."
                sh "docker system prune --force --filter 'until=24h' || true"
                cleanWs()
            }
        }
    }
}

// **ðŸ”¹ è¾…åŠ©å‡½æ•°**
def determineEnvironment() {
    def envMap = [
        'master': 'production',
        'test': 'test',
        'develop': 'development'
    ]
    env.ENVIRONMENT = envMap.get(env.BRANCH_NAME, 'development')

    def portMap = [
        'production': '9091',
        'test': '9092',
        'development': '9093'
    ]
    env.DOCKER_PORT = portMap.get(env.ENVIRONMENT, '9099')

    env.CONTAINER_NAME = "fs-container-${env.ENVIRONMENT}"
}

def containerExists(String name) {
    return sh(
        script: "docker inspect --format='{{.State.Running}}' ${name} >/dev/null 2>&1 && echo true || echo false",
        returnStdout: true
    ).trim() == 'true'
}
