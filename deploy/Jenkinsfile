pipeline {
    agent any

    environment {
        GIT_REPO = "git@github.com:CodarZ/fastapi-service.git"
        IMAGE_NAME = "fs-image"
        DOCKERFILE_PATH = "deploy/Dockerfile"
    }

    stages {
        stage('å‡†å¤‡ç¯å¢ƒ') {
            steps {
                script {
                    echo "â–¶ï¸ å¼€å§‹æ„å»º FastAPI æœåŠ¡..."
                }
            }
        }

        stage('è®¡ç®—ç¯å¢ƒå˜é‡') {
            steps {
                script {
                    determineEnvironment()
                    echo "ğŸ“Œ éƒ¨ç½²ç¯å¢ƒ: ${env.ENVIRONMENT} | ç«¯å£: ${env.DOCKER_PORT} | å®¹å™¨å: ${env.CONTAINER_NAME}"
                }
            }
        }

        stage('æ‹‰å–ä»£ç ') {
            steps {
                echo "ğŸ”„ ä» Git ä»“åº“æ‹‰å– ${env.BRANCH_NAME} åˆ†æ”¯çš„æœ€æ–°ä»£ç ..."
                git branch: "${env.BRANCH_NAME}", url: "${env.GIT_REPO}"
            }
        }

        stage('æ„å»º Docker é•œåƒ') {
            steps {
                script {
                    def timestamp = sh(script: 'date +%Y%m%d%H%M%S', returnStdout: true).trim()
                    def gitCommit = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.IMAGE_TAG = "${env.IMAGE_NAME}:${timestamp}"
                    
                    echo "ğŸ”¨ æ„å»º Docker é•œåƒ: ${env.IMAGE_TAG} (Git Commit: ${gitCommit})"
                    
                    sh """
                    docker build --cache-from=${env.IMAGE_NAME}:latest \
                        -t ${env.IMAGE_TAG} \
                        -t ${env.IMAGE_NAME}:latest \
                        -f ${env.DOCKERFILE_PATH} .
                    """
                }
            }
        }

        stage('åœæ­¢æ—§å®¹å™¨') {
            steps {
                script {
                    echo "ğŸ›‘ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨: ${env.CONTAINER_NAME} (å¦‚æœå­˜åœ¨)"
                    sh """
                    docker ps -q --filter "name=${env.CONTAINER_NAME}" | grep -q . && \
                    docker stop ${env.CONTAINER_NAME} --time 5 || true
                    docker rm -f ${env.CONTAINER_NAME} || true
                    """
                }
            }
        }

        stage('éƒ¨ç½²æ–°å®¹å™¨') {
            steps {
                script {
                    echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨: ${env.CONTAINER_NAME} (ç«¯å£: ${env.DOCKER_PORT})"
                    sh """
                    docker run -d \
                        --name ${env.CONTAINER_NAME} \
                        -p ${env.DOCKER_PORT}:8000 \
                        -e ENVIRONMENT=${env.ENVIRONMENT} \
                        ${env.IMAGE_TAG}
                    """
                }
            }
        }

        stage('éªŒè¯éƒ¨ç½²') {
            steps {
                script {
                    if (!containerExists(env.CONTAINER_NAME)) {
                        error "âŒ å®¹å™¨ ${env.CONTAINER_NAME} æœªè¿è¡Œï¼"
                    }

                    def healthCheck = sh(
                        script: "curl -s -o /dev/null -w '%{http_code}' http://localhost:${env.DOCKER_PORT}/health || echo '000'",
                        returnStdout: true
                    ).trim()

                    echo "ğŸ” å¥åº·æ£€æŸ¥ HTTP çŠ¶æ€ç : ${healthCheck}"

                    if (healthCheck != "200") {
                        echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP ${healthCheck})ï¼Œä½†ä¸ä¼šå½±å“æµæ°´çº¿ç»§ç»­è¿è¡Œã€‚"
                    } else {
                        echo "âœ… æœåŠ¡åœ¨ç«¯å£ ${env.DOCKER_PORT} ä¸Šæ­£å¸¸è¿è¡Œ"
                    }
                }
            }
        }

        stage('æ£€æŸ¥æ—¥å¿—') {
            steps {
                echo "ğŸ“œ æ‰“å°æœ€è¿‘ 50 è¡Œå®¹å™¨æ—¥å¿—: ${env.CONTAINER_NAME}"
                sh "docker logs --tail 50 ${env.CONTAINER_NAME} || true"
            }
        }
    }

    post {
        success {
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        }
        failure {
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼"
        }
        always {
            script {
                echo "ğŸ§¹ æ¸…ç† 3 å¤©å‰çš„æ—§é•œåƒå’Œæ— ç”¨ Docker èµ„æº..."
                sh '''
                docker images --filter "reference=fs-image" --format "{{.Repository}}:{{.Tag}} {{.CreatedAt}}" | \
                awk '$2 < "'$(date -d "3 days ago" '+%Y-%m-%d')'" {print $1}' | xargs -r docker rmi || true

                docker system prune --force --filter "until=24h" || true
                '''
                cleanWs()
            }
        }
    }
}

// **ğŸ”¹ è¾…åŠ©å‡½æ•°**
def determineEnvironment() {
    def envMap = [
        'master': 'production',
        'test': 'test',
        'develop': 'development'
    ]
    env.ENVIRONMENT = envMap.get(env.BRANCH_NAME, 'development')

    def portMap = [
        'production': '9091',
        'test': '9092',
        'development': '9093'
    ]
    env.DOCKER_PORT = portMap.get(env.ENVIRONMENT, '9099')

    env.CONTAINER_NAME = "fs-container-${env.ENVIRONMENT}"
}

def containerExists(String name) {
    return sh(
        script: "docker inspect --format='{{.State.Running}}' ${name} >/dev/null 2>&1 && echo true || echo false",
        returnStdout: true
    ).trim() == 'true'
}
